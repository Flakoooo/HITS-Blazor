@namespace HITSBlazor.Layout
@using Microsoft.AspNetCore.Components.Web

@if (IsOpened)
{
    <div id="@Id"
         class="@GetModalClass()"
         @onclick="HandleBackdropClick"
         style="display: block;">
        @ChildContent
    </div>
}
else if (isAnimating)
{
    <div id="@Id"
         class="@GetModalClass() fade-out"
         style="display: block; pointer-events: none;">
        @ChildContent
    </div>
}

@code {
    [Parameter] public string? Id { get; set; }
    [Parameter] public bool IsOpened { get; set; }
    [Parameter] public string? ClassName { get; set; }
    [Parameter] public bool AllowOutsideClose { get; set; } = true;
    [Parameter] public EventCallback OnOutsideClose { get; set; }
    [Parameter] public RenderFragment? ChildContent { get; set; }

    private bool isAnimating = false;
    private bool wasOpened = false;
    private Timer? animationTimer;

    protected override void OnParametersSet()
    {
        if (IsOpened != wasOpened)
        {
            if (IsOpened)
            {
                isAnimating = true;
                wasOpened = true;
            }
            else if (wasOpened)
            {
                isAnimating = true;

                // Запускаем таймер для завершения анимации
                animationTimer?.Dispose();
                animationTimer = new Timer(_ =>
                {
                    InvokeAsync(() =>
                    {
                        isAnimating = false;
                        wasOpened = false;
                        StateHasChanged();
                    });
                }, null, 150, Timeout.Infinite);
            }
        }
    }

    private string GetModalClass()
    {
        var classes = new List<string> { "modal-layout" };

        if (IsOpened && !isAnimating)
            classes.Add("fade-in");
        else if (!IsOpened && isAnimating)
            classes.Add("fade-out");

        if (!string.IsNullOrEmpty(ClassName))
            classes.Add(ClassName);

        return string.Join(" ", classes);
    }

    private async Task HandleBackdropClick()
    {
        if (AllowOutsideClose && OnOutsideClose.HasDelegate)
        {
            await OnOutsideClose.InvokeAsync();
        }
    }

    public void Open() => IsOpened = true;
    public void Close() => IsOpened = false;
    public void Toggle() => IsOpened = !IsOpened;

    public void Dispose()
    {
        animationTimer?.Dispose();
    }
}