@using HITSBlazor.Components
@using HITSBlazor.Components.LeftSideBar
@using HITSBlazor.Components.RoleModal
@using HITSBlazor.Services.Auth
@inherits LayoutComponentBase
@inject IAuthService AuthService

<div style="display: flex; flex-direction: row; flex-wrap: nowrap; align-items: flex-start; justify-content: flex-start;">
    @if (isInitialized)
    {
        @if (IsAuthenticated)
        {
            <LeftSideNavigation />
            <main class="w-100 overflow-y-scroll bg-white" style="height: 100vh; display: grid; grid-template-rows: min-content auto;">
                @Body
            </main>
        }
        else
        {
            @Body
        }

        <GlobalNotification />
    }
    else
    {
        <div class="loading-container d-flex justify-content-center align-items-center h-100">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Загрузка...</span>
            </div>
        </div>
    }
</div>

@code {
    private RoleModal? roleModal;

    private bool isInitialized = false;

    private bool IsAuthenticated { get; set; } = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            AuthService.OnAuthStateChanged += AuthStateChanged;
            await AuthService.InitializeAsync();
            IsAuthenticated = AuthService.IsAuthenticated;

            if (IsAuthenticated && AuthService.CurrentUser?.Role == null)
            {
                await Task.Delay(100);
                roleModal?.Open();
            }

            isInitialized = true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ошибка инициализации MainLayout: {ex.Message}");
            isInitialized = true;
        }
    }

    public void AuthStateChanged()
    {
        var newValue = AuthService.IsAuthenticated;
        if (IsAuthenticated != newValue)
        {
            IsAuthenticated = newValue;
            InvokeAsync(StateHasChanged);
        }
    }

    public void Dispose()
    {
        AuthService.OnAuthStateChanged -= AuthStateChanged;
    }
}