@using HITSBlazor.Components
@using HITSBlazor.Components.LeftSideBar
@using HITSBlazor.Components.RoleModal
@using HITSBlazor.Services.Auth
@inherits LayoutComponentBase
@inject IAuthService AuthService


<div class="d-flex h-100">
    @if (isInitialized)
    {
        @if (IsAuthenticated)
        {
            <!--<LeftSideBar />-->
            <!--<RoleModal @ref="roleModal" />-->
            <LeftSideNavigation />
        }

        <main class="flex-grow-1 overflow-auto">
            @Body
        </main>

        <GlobalNotification />
    }
    else
    {
        <div class="loading-container d-flex justify-content-center align-items-center h-100">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Загрузка...</span>
            </div>
        </div>
    }
</div>

@code {
    private RoleModal? roleModal;

    private bool isInitialized = false;

    private bool IsAuthenticated { get; set; } = false;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            AuthService.OnAuthStateChanged += AuthStateChanged;
            await AuthService.InitializeAsync();
            IsAuthenticated = AuthService.IsAuthenticated;

            if (IsAuthenticated && AuthService.CurrentUser?.Role == null)
            {
                await Task.Delay(100);
                roleModal?.Open();
            }

            isInitialized = true;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ошибка инициализации MainLayout: {ex.Message}");
            isInitialized = true;
        }
    }

    public void AuthStateChanged()
    {
        var newValue = AuthService.IsAuthenticated;
        if (IsAuthenticated != newValue)
        {
            IsAuthenticated = newValue;
            InvokeAsync(StateHasChanged);
        }
    }

    public void Dispose()
    {
        AuthService.OnAuthStateChanged -= AuthStateChanged;
    }
}