@namespace HITSBlazor.Components
@using HITSBlazor.Services.Modal
@using Microsoft.AspNetCore.Components
@implements IDisposable
@inject ModalService ModalService

@if (IsVisible)
{
    <div @onclick="CloseModal"
         style="position: fixed; top: 0; right: 0; bottom: 0; left: 0; z-index: 10; background-color: rgba(0,0,0,.365); display: grid; transition: opacity .15s ease-out;">
        @if (CurrentComponentType != null)
        {
            <DynamicComponent Type="@CurrentComponentType"
                              Parameters="@Parameters" />
        }
    </div>
}

@code {
    private bool IsVisible { get; set; }
    private bool IsBlockCloseModal { get; set; }
    private Type? CurrentComponentType { get; set; }
    private Dictionary<string, object> Parameters { get; set; } = new();

    protected override void OnInitialized()
    {
        ModalService.OnShow += ShowModal;
        ModalService.OnClose += CloseModal;
    }

    private void ShowModal(ModalData modalData)
    {
        CurrentComponentType = modalData.ComponentType;
        Parameters = modalData.Parameters;
        IsVisible = true;
        IsBlockCloseModal = modalData.BlockCloseModal;
        StateHasChanged();
    }

    private void CloseModal()
    {
        IsVisible = false;
        CurrentComponentType = null;
        Parameters.Clear();
        StateHasChanged();
    }

    public void Dispose()
    {
        ModalService.OnShow -= ShowModal;
        ModalService.OnClose -= CloseModal;
    }
}