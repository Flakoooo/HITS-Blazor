@namespace HITSBlazor.Components.GlobalNotification
@using HITSBlazor.Services
@implements IDisposable

@if (_notifications.Count > 0)
{
    <div class="notification-container">
        @foreach (var notification in _notifications)
        {
            <div class="alert @notification.AlertClass alert-dismissible show fade @notification.AlertAnimation"
                 style="--notification-index: @notification.Index;"
                 role="alert">
                <div class="notification-content">
                    @notification.Message
                </div>
                <button type="button" class="btn-close" @onclick="() => HideNotification(notification.Id)"></button>
            </div>
        }
    </div>
}

@code {
    private List<GlobalNotificationItem> _notifications = [];
    private bool _isDisposed;

    [Inject]
    private GlobalNotificationService NotificationService { get; set; } = null!;

    protected override void OnInitialized()
    {
        NotificationService.OnErrorNotification += ShowError;
        NotificationService.OnSuccessNotification += ShowSuccess;
        NotificationService.OnClearNotification += ClearAll;
    }

    private void ShowError(string errorMessage) => ShowNotification(errorMessage, true);

    private void ShowSuccess(string successMessage) => ShowNotification(successMessage, false);

    private async void ShowNotification(string message, bool error)
    {
        var existNtf = _notifications.FirstOrDefault(n => n.Message == message);
        if (existNtf is not null)
        {
            var index = _notifications.IndexOf(existNtf);
            if (index > 0)
            {
                existNtf.AlertAnimation = "alert-slide-out";
                StateHasChanged();
                await Task.Delay(300);
                _notifications.RemoveAt(index);
                StateHasChanged();
                existNtf.AlertAnimation = "alert-slide-in";
                _notifications.Insert(0, existNtf);
                StateHasChanged();
                await Task.Delay(300);
                existNtf.AlertAnimation = "";
                StateHasChanged();
                UpdateNotificationIndices();
                StateHasChanged();
            }
            StartAutoRemoveTimer(existNtf);

            return;
        }

        var notification = new GlobalNotificationItem
        {
            Id = Guid.NewGuid(),
            Message = message,
            IsError = error,
            Index = _notifications.Count
        };
        _notifications.Insert(0, notification);
        StateHasChanged();
        await Task.Delay(300);
        _notifications.ElementAt(0).AlertAnimation = "";
        StateHasChanged();
        UpdateNotificationIndices();
        StateHasChanged();

        StartAutoRemoveTimer(notification);
    }

    private void StartAutoRemoveTimer(GlobalNotificationItem notification)
    {
        notification.AutoRemoveCts?.Cancel();
        notification.AutoRemoveCts?.Dispose();

        notification.AutoRemoveCts = new CancellationTokenSource();

        _ = AutoRemoveNotificationAsync(notification.Id, notification.AutoRemoveCts.Token);
    }

    private async Task AutoRemoveNotificationAsync(Guid notificationId, CancellationToken cancellationToken)
    {
        try
        {
            await Task.Delay(5000, cancellationToken);

            if (!cancellationToken.IsCancellationRequested)
            {
                await InvokeAsync(async () =>
                {
                    await HideNotificationWithAnimation(notificationId);
                });
            }
        }
        catch (TaskCanceledException)
        {
            
        }
    }

    private async Task HideNotificationWithAnimation(Guid id)
    {
        if (_isDisposed) return;

        var ntf = _notifications.FirstOrDefault(n => n.Id == id);
        if (ntf is null) return;

        ntf.AlertAnimation = "alert-slide-out";
        StateHasChanged();
        await Task.Delay(300);

        if (_isDisposed) return;

        _notifications.RemoveAll(n => n.Id == id);
        UpdateNotificationIndices();
        StateHasChanged();

        ntf.Dispose();
    }

    private async void HideNotification(Guid id)
    {
        await HideNotificationWithAnimation(id);
    }

    private void UpdateNotificationIndices()
    {
        for (int i = 0; i < _notifications.Count; i++)
            _notifications[i].Index = i;
    }

    private void ClearAll()
    {
        _notifications.Clear();
        StateHasChanged();
    }

    public void Dispose()
    {
        _isDisposed = true;

        NotificationService.OnErrorNotification -= ShowError;
        NotificationService.OnSuccessNotification -= ShowSuccess;
        NotificationService.OnClearNotification -= ClearAll;

        foreach (var notification in _notifications)
            notification.Dispose();

        _notifications.Clear();
    }
}