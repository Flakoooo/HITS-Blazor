@namespace HITSBlazor.Components.RoleModal
@using HITSBlazor.Components.Button
@using HITSBlazor.Components.Typography
@using HITSBlazor.Models.Users.Enums
@using HITSBlazor.Services.Auth
@using HITSBlazor.Models.Users.Entities
@inject IAuthService AuthService
@inject NavigationManager NavigationManager

<ModalLayout IsOpened="IsOpened"
             AllowOutsideClose="true"
             OnOutsideClose="CloseModal">
    <div class="role-modal p-3 rounded bg-white">
        <Typography ClassName="fs-3 text-primary text-center mb-3">
            Доступные роли
        </Typography>

        @if (User?.Roles != null && User.Roles.Any())
        {
            <div class="d-flex flex-column gap-2">
                @foreach (var role in User.Roles)
                {
                    <Button Type="button"
                            Variant="@(User.Role == role ? "success" : "primary")"
                            ClassName="w-100"
                            OnClick="() => HandleChooseRole(role)"
                            Disabled="@IsActiveRole(role)">
                        @GetTranslatedRole(role)
                        @if (User.Role == role)
                        {
                            <span class="ms-2">(текущая)</span>
                        }
                    </Button>
                }
            </div>
        }
        else
        {
            <p class="text-center text-muted">Нет доступных ролей</p>
        }
    </div>
</ModalLayout>

@code {
    [Parameter] public bool IsOpened { get; set; }
    [Parameter] public EventCallback OnClose { get; set; }

    private User? User => AuthService.CurrentUser;

    private readonly Dictionary<RoleType, string> RoleTranslations = new()
    {
        { RoleType.INITIATOR,       "Инициатор"         },
        { RoleType.TEAM_OWNER,      "Владелец команды"  },
        { RoleType.TEAM_LEADER,     "Лидер команды"     },
        { RoleType.MEMBER,          "Участник"          },
        { RoleType.PROJECT_OFFICE,  "Проектный офис"    },
        { RoleType.EXPERT,          "Эксперт"           },
        { RoleType.ADMIN,           "Администратор"     },
        { RoleType.TEACHER,         "Учитель"           }
    };

    private bool IsActiveRole(RoleType role) => User?.Role == role;

    private string GetTranslatedRole(RoleType role)
    {
        return RoleTranslations.TryGetValue(role, out var translation)
            ? translation
            : role.ToString();
    }

    private async Task HandleChooseRole(RoleType role)
    {
        if (User == null || User.Role == role)
            return;

        try
        {
            await AuthService.SetUserRoleAsync(role);

            NavigationManager.NavigateTo(NavigationManager.Uri, true);

            await CloseModal();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Ошибка при выборе роли: {ex.Message}");
        }
    }

    private async Task CloseModal()
    {
        IsOpened = false;
        if (OnClose.HasDelegate)
            await OnClose.InvokeAsync();
        StateHasChanged();
    }

    public void Open()
    {
        IsOpened = true;
        StateHasChanged();
    }

    public void Close()
    {
        IsOpened = false;
        StateHasChanged();
    }
}