@namespace HITSBlazor.Components.LeftSideBar
@using HITSBlazor.Components.NotificationModalWindow
@using HITSBlazor.Components.RoleModal
@using HITSBlazor.Models.Users.Entities
@using HITSBlazor.Models.Users.Enums
@using HITSBlazor.Components.NavTab
@using HITSBlazor.Components.Button
@using HITSBlazor.Components.Placeholders
@using HITSBlazor.Services.Auth
@using HITSBlazor.Services.Notifications
@inject IAuthService AuthService
@inject INotificationService NotificationService
@inject NavigationManager Navigation
@implements IDisposable

@if (User?.Role != null)
{
    <div @ref="leftSideBarRef"
         class="@GetSideBarClass()"
         @onmouseenter="OnMouseEnter"
         @onmouseleave="OnMouseLeave">

        <ul class="left-side-bar__content nav nav-pills w-100 gap-2">
            @foreach (var tab in filteredTabs)
            {
                <NavTab Label="@(isHovered? tab.Text: "")"
                        IconName="@tab.IconName"
                        To="@tab.To"
                        Routes="@ConvertToNavRoutes(tab.Routes)"
                        WrapperClassName="@(isHovered ? "left-side-bar__link w-100" : "")"
                        ClassName="@(isHovered ? "text-white" : "")"
                        CurrentUser="@User" />
            }
        </ul>

        <div class="d-flex flex-column gap-2">
            <Button Type="button"
                    ClassName="left-side-bar__button btn-light w-100 text-success"
                    PrependIconName="bi bi-circle-fill fs-6"
                    OnClick="OpenRoleModal"
                    Disabled="@UserHaveMoreRoles">
                @if (isHovered)
                {
                    @GetTranslatedRole(User.Role.Value)
                }
            </Button>

            <Button Type="button"
                    ClassName="left-side-bar__button btn-light w-100"
                    PrependIconName="bi bi-bell"
                    OnClick="OpenNotificationsModal">
                @if (isHovered)
                {
                    <span>Уведомления</span>
                    @if (unreadCount > 0)
                    {
                        <span class="badge bg-danger ms-1">@unreadCount</span>
                    }
                }
            </Button>

            <Button Type="button"
                    ClassName="left-side-bar__button btn-light w-100"
                    PrependIconName="bi bi-box-arrow-left"
                    OnClick="HandleLogout">
                @if (isHovered)
                {
                    <span>Выйти</span>
                }
            </Button>
        </div>

        @if (isHovered)
        {
            <div class="mt-auto pt-2 text-center">
                <small class="text-white-50">Версия 1.0.0</small>
            </div>
        }

        <RoleModal @ref="roleModal" />
        <NotificationModalWindow @ref="notificationModal" />
    </div>
}
else
{
    <LeftSideBarPlaceholder />
}

@code {
    // Refs
    private Microsoft.AspNetCore.Components.ElementReference? leftSideBarRef;
    private RoleModal? roleModal;
    private NotificationModalWindow? notificationModal;

    // Состояние
    private bool isHovered = false;
    private bool isAnimating = false;
    private bool UserHaveMoreRoles => User?.Roles?.Count <= 1;
    private int unreadCount = 0;
    private List<LeftSideBarTab> tabs = new();
    private List<LeftSideBarTab> filteredTabs = new();

    // Таймеры
    private Timer? hoverTimer;
    private Timer? unreadCountTimer;

    // Сервисы
    [Inject] private IJSRuntime JSRuntime { get; set; } = null!;

    // Пользователь
    private User? User => AuthService.CurrentUser;

    // Переводы ролей
    private readonly Dictionary<RoleType, string> roleTranslations = new()
    {
        { RoleType.Initiator,       "Инициатор"         },
        { RoleType.TeamOwner,       "Владелец команды"  },
        { RoleType.TeamLeader,      "Лидер команды"     },
        { RoleType.Member,          "Участник"          },
        { RoleType.ProjectOffice,   "Проектный офис"    },
        { RoleType.Expert,          "Эксперт"           },
        { RoleType.Admin,           "Администратор"     },
        { RoleType.Teacher,         "Учитель"           }
    };

    protected override async Task OnInitializedAsync()
    {
        tabs = LeftSideBarTabs.GetTabs();

        AuthService.OnAuthStateChanged += OnAuthStateChanged;
        NotificationService.OnNotificationsUpdated += OnNotificationsUpdated;
        NotificationService.OnUnreadCountChanged += OnUnreadCountChanged;

        await UpdateUnreadCount();
        UpdateFilteredTabs();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            unreadCountTimer = new Timer(async _ =>
            {
                await InvokeAsync(async () =>
                {
                    await UpdateUnreadCount();
                });
            }, null, TimeSpan.Zero, TimeSpan.FromSeconds(30));
        }
    }

    private void OnAuthStateChanged()
    {
        InvokeAsync(() =>
        {
            UpdateFilteredTabs();
            StateHasChanged();
        });
    }

    private void OnNotificationsUpdated()
    {
        InvokeAsync(async () =>
        {
            await UpdateUnreadCount();
        });
    }

    private void OnUnreadCountChanged(int count)
    {
        unreadCount = count;
        StateHasChanged();
    }

    private async Task UpdateUnreadCount()
    {
        try
        {
            unreadCount = await NotificationService.GetUnreadCountAsync();
            StateHasChanged();
        }
        catch
        {
            unreadCount = 0;
        }
    }

    private void UpdateFilteredTabs()
    {
        if (User?.Role == null)
        {
            filteredTabs = new List<LeftSideBarTab>();
            return;
        }

        filteredTabs = tabs
            .Where(tab => tab.Roles.Contains(User.Role.Value))
            .ToList();
    }

    private List<NavRoute>? ConvertToNavRoutes(List<LeftSideBarTab>? sidebarRoutes)
    {
        if (sidebarRoutes == null || !sidebarRoutes.Any())
            return null;

        return sidebarRoutes.Select(r => new NavRoute
        {
            Name = r.Name,
            To = r.To,
            Text = r.Text,
            IconName = r.IconName,
            Roles = r.Roles
        }).ToList();
    }

    private string GetTranslatedRole(RoleType role)
    {
        return roleTranslations.TryGetValue(role, out var translation)
            ? translation
            : role.ToString();
    }

    private string GetSideBarClass()
    {
        var classes = new List<string>
        {
            "left-side-bar",
            "h-100",
            "d-flex",
            "flex-column"
        };

        if (isAnimating)
        {
            classes.Add("left-side-bar--animating");
            classes.Add(isHovered ? "left-side-bar--opened" : "left-side-bar--closed");
        }
        else
        {
            classes.Add(isHovered ? "left-side-bar--opened" : "left-side-bar--closed");
        }

        return string.Join(" ", classes);
    }

    private void OnMouseEnter()
    {
        hoverTimer?.Dispose();

        hoverTimer = new Timer(_ =>
        {
            InvokeAsync(() =>
            {
                isHovered = true;
                isAnimating = true;
                StateHasChanged();

                // Сбрасываем флаг анимации через время анимации
                Task.Delay(150).ContinueWith(_ =>
                {
                    InvokeAsync(() =>
                    {
                        isAnimating = false;
                        StateHasChanged();
                    });
                });
            });
        }, null, 400, Timeout.Infinite); // Задержка как в Vue (400ms)
    }

    private void OnMouseLeave()
    {
        hoverTimer?.Dispose();

        hoverTimer = new Timer(_ =>
        {
            InvokeAsync(() =>
            {
                isHovered = false;
                isAnimating = true;
                StateHasChanged();

                Task.Delay(150).ContinueWith(_ =>
                {
                    InvokeAsync(() =>
                    {
                        isAnimating = false;
                        StateHasChanged();
                    });
                });
            });
        }, null, 100, Timeout.Infinite); // Задержка перед скрытием
    }

    private void OpenRoleModal()
    {
        roleModal?.Open();
    }

    private void OpenNotificationsModal()
    {
        notificationModal?.Open();
    }

    private async Task HandleLogout()
    {
        await AuthService.LogoutAsync();
        Navigation.NavigateTo("/", true);
    }

    public void Dispose()
    {
        hoverTimer?.Dispose();
        unreadCountTimer?.Dispose();

        // Отписываемся от событий
        AuthService.OnAuthStateChanged -= OnAuthStateChanged;
        NotificationService.OnNotificationsUpdated -= OnNotificationsUpdated;
        NotificationService.OnUnreadCountChanged -= OnUnreadCountChanged;
    }
}