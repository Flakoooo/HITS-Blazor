@namespace HITSBlazor.Components.LeftSideBar
@using HITSBlazor.Components.NotificationModalWindow
@using HITSBlazor.Components.RoleModal
@using HITSBlazor.Models.Users.Entities
@using HITSBlazor.Models.Users.Enums
@using HITSBlazor.Components.NavTab
@using HITSBlazor.Components.Button
@using HITSBlazor.Components.Placeholders
@using HITSBlazor.Services.Auth
@using HITSBlazor.Services.Notifications
@inject IAuthService AuthService
@inject INotificationService NotificationService
@inject NavigationManager Navigation
@implements IDisposable

@if (User?.Role != null)
{
    <div @ref="leftSideBarRef" 
         class="@GetSideBarClass()" 
         @onmouseenter="OnMouseEnter" 
         @onmouseleave="OnMouseLeave">
        
        <ul class="left-side-bar__content nav nav-pills w-100 gap-2">
            @foreach (var tab in filteredTabs)
            {
                <NavTab Label="@(isHovered ? tab.Text : "")"
                        IconName="@tab.IconName"
                        To="@tab.To"
                        Routes="@ConvertToNavRoutes(tab.Routes)"
                        WrapperClassName="@(isHovered ? "left-side-bar__link w-100" : "")"
                        ClassName="@(isHovered ? "text-white" : "")" />
            }
        </ul>

        <div class="d-flex flex-column gap-2">
            <Button Type="button"
                    ClassName="left-side-bar__button btn-light w-100 text-success"
                    PrependIconName="bi bi-circle-fill fs-6"
                    OnClick="OpenRoleModal"
                    Disabled="@ChangeRoleDisabled">
                @if (isHovered)
                {
                    @GetTranslatedRole(User.Role.Value)
                }
            </Button>

            <Button Type="button"
                    ClassName="left-side-bar__button btn-light w-100"
                    PrependIconName="bi bi-bell"
                    OnClick="OpenNotificationsModal">
                @if (isHovered)
                {
                    <span>Уведомления</span>
                    @if (unreadCount > 0)
                    {
                        <span class="badge bg-danger ms-1">@unreadCount</span>
                    }
                }
            </Button>

            <Button Type="button"
                    ClassName="left-side-bar__button btn-light w-100"
                    PrependIconName="bi bi-box-arrow-left"
                    OnClick="HandleLogout">
                @if (isHovered)
                {
                    <span>Выйти</span>
                }
            </Button>
        </div>

        <RoleModal @ref="roleModal" />
        <NotificationModalWindow @ref="notificationModal" />
    </div>
}
else
{
    <LeftSideBarPlaceholder />
}

@code {
    // Refs
    private Microsoft.AspNetCore.Components.ElementReference? leftSideBarRef;
    private RoleModal? roleModal;
    private NotificationModalWindow? notificationModal;

    // Состояние
    private bool isHovered = false;
    private bool isAnimating = false;
    private int unreadCount = 0;
    private List<LeftSideBarTab> tabs = new();
    private List<LeftSideBarTab> filteredTabs = new();
    
    // Таймеры и таски
    private Timer? hoverTimer;
    private Timer? unreadCountTimer;
    private CancellationTokenSource? cts;
    
    // Сервисы
    [Inject] private IJSRuntime JSRuntime { get; set; } = null!;
    
    // Пользователь
    private User? User => AuthService.CurrentUser;
    private bool ChangeRoleDisabled => User?.Roles?.Count <= 1;
    
    // Переводы ролей
    private Dictionary<RoleType, string> roleTranslations = new()
    {
        { RoleType.INITIATOR,       "Инициатор"         },
        { RoleType.TEAM_OWNER,      "Владелец команды"  },
        { RoleType.TEAM_LEADER,     "Лидер команды"     },
        { RoleType.MEMBER,          "Участник"          },
        { RoleType.PROJECT_OFFICE,  "Проектный офис"    },
        { RoleType.EXPERT,          "Эксперт"           },
        { RoleType.ADMIN,           "Администратор"     },
        { RoleType.TEACHER,         "Учитель"           }
    };

    protected override async Task OnInitializedAsync()
    {
        tabs = LeftSideBarTabs.GetTabs();
        
        AuthService.OnAuthStateChanged += OnAuthStateChanged;
        NotificationService.OnNotificationsUpdated += OnNotificationsUpdated;
        NotificationService.OnUnreadCountChanged += OnUnreadCountChanged;
        
        // Загружаем начальные данные
        await UpdateUnreadCount();
        UpdateFilteredTabs();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Начинаем периодическое обновление счетчика
            unreadCountTimer = new Timer(async _ => 
            {
                await InvokeAsync(async () =>
                {
                    await UpdateUnreadCount();
                    StateHasChanged();
                });
            }, null, TimeSpan.Zero, TimeSpan.FromSeconds(30));
        }
    }

    private void OnAuthStateChanged()
    {
        InvokeAsync(async () =>
        {
            UpdateFilteredTabs();
            await UpdateUnreadCount();
            StateHasChanged();
        });
    }

    private void OnNotificationsUpdated()
    {
        InvokeAsync(async () =>
        {
            await UpdateUnreadCount();
            StateHasChanged();
        });
    }

    private void OnUnreadCountChanged(int count)
    {
        unreadCount = count;
        StateHasChanged();
    }

    private async Task UpdateUnreadCount()
    {
        try
        {
            unreadCount = await NotificationService.GetUnreadCountAsync();
        }
        catch
        {
            unreadCount = 0;
        }
    }

    private void UpdateFilteredTabs()
    {
        if (User?.Role == null)
        {
            filteredTabs = new List<LeftSideBarTab>();
            return;
        }

        filteredTabs = tabs.Where(tab => tab.Roles.Contains(User.Role.Value)).ToList();
    }

    private List<NavRoute>? ConvertToNavRoutes(List<LeftSideBarTab>? sidebarRoutes)
    {
        if (sidebarRoutes == null || !sidebarRoutes.Any())
            return null;

        return sidebarRoutes.Select(r => new NavRoute
        {
            To = r.To,
            Text = r.Text,
            IconName = r.IconName,
            Roles = r.Roles.Select(role => role.ToString()).ToList()
        }).ToList();
    }

    private string GetTranslatedRole(RoleType role)
    {
        return roleTranslations.TryGetValue(role, out var translation) 
            ? translation 
            : role.ToString();
    }

    private string GetSideBarClass()
    {
        var classes = new List<string>
        {
            "left-side-bar",
            "p-3",
            "h-100"
        };

        if (isAnimating)
        {
            if (isHovered)
                classes.Add("left-side-bar--opened");
            else
                classes.Add("left-side-bar--closed");
        }
        else if (isHovered)
        {
            classes.Add("left-side-bar--opened");
        }

        return string.Join(" ", classes);
    }

    private async void OnMouseEnter()
    {
        hoverTimer?.Dispose();
        
        hoverTimer = new Timer(_ =>
        {
            InvokeAsync(() =>
            {
                isHovered = true;
                isAnimating = true;
                StateHasChanged();
                
                // Сбрасываем анимацию через время анимации
                Task.Delay(150).ContinueWith(_ =>
                {
                    InvokeAsync(() =>
                    {
                        isAnimating = false;
                        StateHasChanged();
                    });
                });
            });
        }, null, 400, Timeout.Infinite);
    }

    private void OnMouseLeave()
    {
        hoverTimer?.Dispose();
        
        hoverTimer = new Timer(_ =>
        {
            InvokeAsync(() =>
            {
                isHovered = false;
                isAnimating = true;
                StateHasChanged();
                
                Task.Delay(150).ContinueWith(_ =>
                {
                    InvokeAsync(() =>
                    {
                        isAnimating = false;
                        StateHasChanged();
                    });
                });
            });
        }, null, 100, Timeout.Infinite);
    }

    private void OpenRoleModal()
    {
        roleModal?.Open();
    }

    private void OpenNotificationsModal()
    {
        notificationModal?.Open();
    }

    private async Task HandleLogout()
    {
        await AuthService.LogoutAsync();
    }

    public void Dispose()
    {
        hoverTimer?.Dispose();
        unreadCountTimer?.Dispose();
        cts?.Cancel();
        
        AuthService.OnAuthStateChanged -= OnAuthStateChanged;
        NotificationService.OnNotificationsUpdated -= OnNotificationsUpdated;
        NotificationService.OnUnreadCountChanged -= OnUnreadCountChanged;
    }
}