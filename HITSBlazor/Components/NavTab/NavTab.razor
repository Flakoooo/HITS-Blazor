@namespace HITSBlazor.Components.NavTab
@using HITSBlazor.Components.Icon
@using HITSBlazor.Components.Typography
@using HITSBlazor.Components.Collapse
@using HITSBlazor.Models.Users.Entities
@using HITSBlazor.Models.Users.Enums
@inject NavigationManager NavigationManager

<div class="@GetWrapperClass()">
    @if (Routes == null || !Routes.Any())
    {
        <NavLink class="@GetNavTabClass(false)"
                 href="@To"
                 ActiveClass="active"
                 Match="GetNavLinkMatch()">
            @RenderIcon()
            @RenderLabel()
        </NavLink>
    }
    else
    {
        <button class="@GetNavTabClass(true)"
                @onclick="ToggleCollapse"
                type="button"
                aria-expanded="@isExpanded.ToString().ToLower()"
                aria-controls="@To">
            @RenderIcon()
            @RenderLabel()
        </button>

        <Collapse Id="@To"
                  ClassName="mt-2"
                  IsExpanded="isExpanded">
            <div class="ps-3 border-start">
                @foreach (var route in GetFilteredRoutes())
                {
                    <NavLink class="nav-route d-flex align-items-center py-1 text-decoration-none text-dark"
                             href="@route.To"
                             ActiveClass="active"
                             Match="NavLinkMatch.Prefix">
                        @if (!string.IsNullOrEmpty(route.IconName))
                        {
                            <Icon ClassName="@($"{route.IconName} me-2")" />
                        }
                        <span class="nav-route__span">@route.Text</span>
                    </NavLink>
                }
            </div>
        </Collapse>
    }
</div>

@code {
    [Parameter] public string? Label { get; set; }
    [Parameter] public string To { get; set; } = "#";
    [Parameter] public string? IconName { get; set; }
    [Parameter] public string? WrapperClassName { get; set; }
    [Parameter] public string? ClassName { get; set; }
    [Parameter] public List<NavRoute>? Routes { get; set; }
    [Parameter] public User? CurrentUser { get; set; }
    [Parameter] public NavLinkMatch Match { get; set; } = NavLinkMatch.Prefix;

    private bool isExpanded = false;
    private string currentUrl = string.Empty;

    protected override void OnInitialized()
    {
        currentUrl = NavigationManager.Uri;
        NavigationManager.LocationChanged += OnLocationChanged;

        if (Routes != null && CheckIsActiveRoute())
        {
            isExpanded = true;
        }
    }

    private void OnLocationChanged(object? sender, Microsoft.AspNetCore.Components.Routing.LocationChangedEventArgs e)
    {
        var oldUrl = currentUrl;
        currentUrl = e.Location;

        if (Routes != null && CheckIsActiveRoute())
        {
            isExpanded = true;
            StateHasChanged();
        }
        else if (isExpanded && !IsParentRouteActive(oldUrl))
        {
            isExpanded = false;
            StateHasChanged();
        }
    }

    private NavLinkMatch GetNavLinkMatch()
    {
        if (Routes == null || !Routes.Any())
            return NavLinkMatch.All;

        return Match;
    }

    private bool CheckIsActiveRoute()
    {
        if (string.IsNullOrEmpty(To) || To == "#")
            return false;

        var currentPath = NavigationManager.ToBaseRelativePath(currentUrl);
        var targetPath = To.TrimStart('/');

        if (currentPath.StartsWith(targetPath, StringComparison.OrdinalIgnoreCase))
            return true;

        if (Routes != null)
        {
            foreach (var route in Routes)
            {
                if (!string.IsNullOrEmpty(route.To) &&
                    currentPath.StartsWith(route.To.TrimStart('/'), StringComparison.OrdinalIgnoreCase))
                {
                    return true;
                }
            }
        }

        return false;
    }

    private bool IsParentRouteActive(string url)
    {
        var path = NavigationManager.ToBaseRelativePath(url);
        var targetPath = To.TrimStart('/');
        return path.StartsWith(targetPath, StringComparison.OrdinalIgnoreCase);
    }

    private string GetWrapperClass()
    {
        var classes = new List<string> { "nav-item" };

        if (!string.IsNullOrEmpty(WrapperClassName))
            classes.Add(WrapperClassName);

        return string.Join(" ", classes);
    }

    private string GetNavTabClass(bool isButton)
    {
        var classes = new List<string> { "nav-link d-flex w-100 align-items-center" };

        if (!string.IsNullOrEmpty(ClassName))
            classes.Add(ClassName);

        if (CheckIsActiveRoute())
            classes.Add("active");

        return string.Join(" ", classes);
    }

    private void ToggleCollapse()
    {
        isExpanded = !isExpanded;
    }

    private bool CheckUserRole(List<RoleType>? roles)
    {
        if (roles == null || !roles.Any() || CurrentUser == null)
            return true;

        return roles.Contains((RoleType)CurrentUser.Role!);
    }

    private List<NavRoute> GetFilteredRoutes()
    {
        if (Routes == null)
            return [];

        return Routes.Where(route => CheckUserRole(route.Roles)).ToList();
    }

    private RenderFragment RenderIcon() => builder =>
    {
        if (!string.IsNullOrEmpty(IconName))
        {
            builder.OpenComponent<Icon>(0);
            builder.AddAttribute(1, "ClassName", $"{IconName} fs-5");
            builder.CloseComponent();
        }
    };

    private RenderFragment RenderLabel() => builder =>
    {
        if (!string.IsNullOrEmpty(Label))
        {
            builder.OpenComponent<Typography>(0);
            builder.AddAttribute(1, "ClassName", "ms-2");
            builder.AddAttribute(2, "ChildContent", (RenderFragment)(childBuilder =>
            {
                childBuilder.AddContent(0, Label);
            }));
            builder.CloseComponent();
        }
    };

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }
}