@namespace HITSBlazor.Components.LeftSideNavigation
@using HITSBlazor.Services
@inject NavigationService NavigationService
@implements IDisposable

<div class="bg-white border-end"
     style="@NavigationLayout"
     @onmouseenter="HandleMouseEnter"
     @onmouseleave="HandleMouseLeave">

    @if (isLoading)
    {
        <div class="p-3 d-flex flex-column gap-2">
            @for (int l = 0; l < 6; l++)
            {
                <div class="placeholder-glow w-100">
                    <span class="placeholder w-100 bg-secondary rounded small"
                          style="height: 50px"></span>
                </div>
            }
        </div>
    }
    else
    {
        <div class="p-3 h-100" style="@NavigationStyle @GetSidebarStyles()">
            <ul class="nav nav-pills w-100 gap-2" style="@NavigationContentStyle">
                @for (int i = 0; i < _menuItems.Count; ++i)
                {
                    var item = _menuItems[i];
                    var isItemActive = item.Id == activeItemId;

                    <div class="@(isHovered ? "nav-item w-100" : "nav-item")"
                        style="@(isHovered ? "border-radius: 6px; transition: background-color .15s ease-out;" : "")">
                        <button type="button"
                                @onclick="() => SelectMenuItem(item.Id)"
                                class="@GetItemButtonClass(item.Id)"
                                style="height: 40px; min-height: 40px; max-height: 40px; flex-direction: row; flex-wrap: nowrap; align-items: center; justify-content: flex-start; gap: 4px;">
                            <i class="@item.Icon fs-5" style="@Styles.Bi">
                            </i>
                            @if (isHovered)
                            {
                                <span class="fs-6 ms-2">@item.Title</span>
                            }
                        </button>
                        @if (isHovered && item.SubItems.Any())
                        {
                            //TODO: Сделать прям точную копию навигации, с раскрывшимся списоком при свернутой навигации
                            <div style="@GetCollapseStyle(item)">
                                <div class="list-group">
                                    <div class="pt-2 rounded">
                                        @for (int j = 0; j < item.SubItems.Count; j++)
                                        {
                                            var subItem = item.SubItems[j];

                                            <a class="@GetSubItemClass(item.Id, subItem.Id)"
                                               @onclick="() => SelectSubItem(item.Id, subItem.Id)"
                                               style="cursor: pointer; display: flex; align-items: center; gap: 8px; padding: 8px 12px;">
                                               <i class="@subItem.Icon" style="@Styles.Bi"></i>
                                               <span>@subItem.Title</span>
                                            </a>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                }
            </ul>

            <div class="d-flex flex-column gap-2">
                <button class="btn d-flex btn-light w-100 text-success"
                        style="height: 40px; min-height: 40px; max-height: 40px; @Styles.Btn"
                        type="button">
                    <i class="bi-circle-fill fs-6" style="@Styles.Bi">
                    </i>
                    @if (isHovered)
                    {
                        <span>ACTIVE_ROLE_NAME</span>
                    }
                </button>
                <button class="btn d-flex btn-light w-100"
                        style="height: 40px; min-height: 40px; max-height: 40px; @Styles.Btn"
                        type="button">
                    <i class="bi-box-arrow-left fs-5" style="@Styles.Bi">
                    </i>
                    @if (isHovered)
                    {
                        <span>Выйти</span>
                    }
                </button>
            </div>
        </div>
    }
</div>

@code {
    private bool isLoading = false;
    private bool isHovered = false;
    private int activeItemId = 0;
    private (int ParentId, int SubItemId) activeSubItem = (0, 0);
    private List<NavigationItem> _menuItems = new();

    private string NavigationLayout => NavigationStyles.Layout;
    private string NavigationStyle => NavigationStyles.GetNavigationStyle();
    private string NavigationContentStyle => NavigationStyles.GetNavigationContentStyle();

    protected override async Task OnInitializedAsync()
    {
        NavigationService.OnNavigationChanged += HandleNavigationChanged;
        _menuItems = NavigationService.GetMenuItems();
        UpdateActiveState();
    }

    private void HandleNavigationChanged() => UpdateActiveState();

    private void UpdateActiveState()
    {
        var currentSubItem = NavigationService.GetCurrentSubItem();
        var currentMenuItem = NavigationService.GetCurrentMenuItem();

        if (currentMenuItem != null)
        {
            activeSubItem = currentSubItem != null 
                ? (currentMenuItem.Id, currentSubItem.Id) 
                : (currentMenuItem.Id, -1);

            foreach (var menuItem in _menuItems)
                menuItem.IsExpanded = menuItem.Id == currentMenuItem.Id &&
                                          (currentSubItem != null || menuItem.SubItems.Any());
        }
    }

    private string GetSidebarStyles() => isHovered
        ? "width: 312px; background-color: rgba(0, 0, 0, 0.729); color: #fff;"
        : "width: 80px; background-color: transparent; color: inherit;";

    private string GetItemButtonClass(int itemId)
    {
        var baseClass = "nav-link d-flex w-100";
        var isActive = activeSubItem.ParentId == itemId;

        if (isActive)
            return $"{baseClass} bg-primary text-white";

        return isHovered ? $"{baseClass} text-white" : $"{baseClass} text-black";
    }

    private string GetSubItemClass(int parentId, int subItemId)
    {
        var baseClass = "nav-route list-group-item list-group-item-light";
        var isActive = activeSubItem.ParentId == parentId && activeSubItem.SubItemId == subItemId;

        return isActive ? $"{baseClass} active router-link-exact-active" : baseClass;
    }

    private string GetCollapseStyle(NavigationItem item)
    {
        if (!item.IsExpanded)
            return "height: 0px; overflow: hidden; transition: height 0.35s ease;";

        var height = 8 + (item.SubItems.Count * 40);
        return $"height: {height}px; overflow: hidden; transition: height 0.35s ease;";
    }

    private void HandleMouseEnter() => isHovered = true;
    private void HandleMouseLeave() => isHovered = false;

    private async Task SelectSubItem(int parentId, int subItemId)
    {
        var parentItem = _menuItems.FirstOrDefault(n => n.Id == parentId);
        var subItem = parentItem?.SubItems.FirstOrDefault(n => n.Id == subItemId);

        if (parentItem == null || subItem == null) return;

        await NavigationService.NavigateToAsync($"{parentItem.BaseUrl}{subItem.Url}");
    }

    private async Task SelectMenuItem(int itemId)
    {
        var item = _menuItems.FirstOrDefault(n => n.Id == itemId);
        if (item == null || string.IsNullOrEmpty(item.BaseUrl)) return;

        if (item.SubItems.Any())
        {
            foreach (var menuItem in _menuItems)
                if (menuItem.Id != itemId && menuItem.IsExpanded)
                    menuItem.IsExpanded = false;

            item.IsExpanded = !item.IsExpanded;

            if (item.SubItems.Count == 0)
                activeSubItem = (itemId, -1);
        }
        else if (!string.IsNullOrEmpty(item.BaseUrl))
            await NavigationService.NavigateToAsync(item.BaseUrl);
    }

    public void Dispose() => 
        NavigationService.OnNavigationChanged -= HandleNavigationChanged;
}