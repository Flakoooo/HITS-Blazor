@namespace HITSBlazor.Components.LeftSideNavigation

<div class="bg-white border-end"
     style="@NavigationLayout"
     @onmouseenter="HandleMouseEnter"
     @onmouseleave="HandleMouseLeave">

    @if (isLoading)
    {
        <div class="p-3 d-flex flex-column gap-2">
            @for (int l = 0; l < 6; l++)
            {
                <div class="placeholder-glow w-100">
                    <span class="placeholder w-100 bg-secondary rounded small"
                          style="height: 50px"></span>
                </div>
            }
        </div>
    }
    else
    {
        <div class="p-3 h-100" style="@NavigationStyle @GetSidebarStyles()">
            <ul class="nav nav-pills w-100 gap-2" style="@NavigationContentStyle">
                @for (int i = 0; i < _menuItems.Count; ++i)
                {
                    var item = _menuItems[i];
                    var isItemActive = item.Id == activeItemId;

                    <li class="@(isHovered ? "nav-item w-100" : "nav-item")"
                        style="@(isHovered ? "border-radius: 6px; transition: background-color .15s ease-out;" : "")">
                        <button type="button"
                                @onclick="() => ToggleMenuItem(item.Id)"
                                class="@GetItemButtonClass(item.Id)"
                                style="align-items: center; gap: 4px;">
                            <i class="icon bi @item.Icon fs-5"></i>
                            @if (isHovered)
                            {
                                <span class="fs-6 ms-2">@item.Title</span>
                            }
                        </button>
                        @if (isHovered && item.SubItems.Any())
                        {
                            <div style="@GetCollapseStyle(item)">
                                <div class="list-group">
                                    <div class="pt-2 rounded">
                                        @for (int j = 0; j < item.SubItems.Count; j++)
                                        {
                                            var subItem = item.SubItems[j];

                                            <a class="@GetSubItemClass(item.Id, subItem.Id)"
                                               @onclick="() => SelectSubItem(item.Id, subItem.Id)"
                                               style="cursor: pointer; display: flex; align-items: center; gap: 8px; padding: 8px 12px;">
                                               <i class="icon bi @subItem.Icon"></i>
                                               <span>@subItem.Title</span>
                                            </a>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                    </li>
                }
            </ul>

            <div class="d-flex flex-column gap-2">
                <button class="btn d-flex btn-light w-100 text-success"
                        style="align-items: center; justify-content: center; gap: 4px;"
                        type="button">
                    <i class="icon bi bi-circle-fill fs-5"></i>
                    @if (isHovered)
                    {
                        <span>ROLE_NAME</span>
                    }
                </button>
                <button class="btn d-flex btn-light w-100"
                        style="align-items: center; justify-content: center; gap: 4px;"
                        type="button">
                    <i class="icon bi bi-box-arrow-left fs-5"></i>
                    @if (isHovered)
                    {
                        <span>Выйти</span>
                    }
                </button>
            </div>
        </div>
    }
</div>

@code {
    private bool isLoading = false;
    private bool isHovered = false;
    private int activeItemId = 0;
    private int? activeSubItemId = 0;

    private (int ParentId, int SubItemId) activeSubItem = (0, 0);

    private List<NavigationItem> _menuItems = new()
    {
        new NavigationItem("Реестр идей", "bi-lightbulb", 0, new()
        {
            new NavigationSubItem("Список идей", "bi-list", 0),
            new NavigationSubItem("Создать идею", "bi-plus-lg", 1)
        }),
        new NavigationItem("Реестр команд", "bi-people", 1, new()
        {
            new NavigationSubItem("Список команд", "bi-list", 0),
            new NavigationSubItem("Создать команду", "bi-plus-lg", 1)
        }),
        new NavigationItem("Реестр бирж", "bi-shop-window", 2, new()
        {
            new NavigationSubItem("Список бирж", "bi-list", 0),
            new NavigationSubItem("ACTIVE_MARKET_NAME", "bi-basket3", 1)
        }),
        new NavigationItem("Админ панель", "bi-ui-checks-grid", 3, new()
        {
            new NavigationSubItem("Пользователи", "bi-person-gear", 0),
            new NavigationSubItem("Добавить пользователей", "bi-person-add", 1),
            new NavigationSubItem("Компании", "bi-building", 2),
            new NavigationSubItem("Группы пользователей", "bi-people", 3),
            new NavigationSubItem("Справочник компетенций", "bi-person-badge", 4),
            new NavigationSubItem("Справочник тегов", "bi-tags", 5)
        }),
        new NavigationItem("Реестр проектов", "bi-briefcase", 4, new()
        {
            new NavigationSubItem("Список проектов", "bi-list", 0),
        }),
        new NavigationItem("Тесты", "bi-clipboard", 5, [])
    };

    private string NavigationLayout => NavigationStyles.Layout;
    private string NavigationStyle => NavigationStyles.GetNavigationStyle();
    private string NavigationContentStyle => NavigationStyles.GetNavigationContentStyle();

    private string GetSidebarStyles() => isHovered
        ? "width: 312px; background-color: rgba(0, 0, 0, 0.729); color: #fff;"
        : "width: 80px; background-color: transparent; color: inherit;";

    private string GetItemButtonClass(int itemId)
    {
        var baseClass = "nav-link d-flex w-100";
        var isActive = activeSubItem.ParentId == itemId;

        if (isActive)
        {
            return $"{baseClass} bg-primary text-white";
        }

        return isHovered ? $"{baseClass} text-white" : $"{baseClass} text-black";
    }

    private string GetSubItemClass(int parentId, int subItemId)
    {
        var baseClass = "nav-route list-group-item list-group-item-light";
        var isActive = activeSubItem.ParentId == parentId && activeSubItem.SubItemId == subItemId;

        return isActive ? $"{baseClass} active router-link-exact-active" : baseClass;
    }

    private string GetCollapseStyle(NavigationItem item)
    {
        if (!item.IsExpanded)
            return "height: 0px; overflow: hidden; transition: height 0.35s ease;";

        var height = 8 + (item.SubItems.Count * 40);
        return $"height: {height}px; overflow: hidden; transition: height 0.35s ease;";
    }

    private void HandleMouseEnter() => isHovered = true;
    private void HandleMouseLeave() => isHovered = false;

    private void ToggleMenuItem(int itemId)
    {
        var item = _menuItems.FirstOrDefault(n => n.Id == itemId);
        if (item == null) return;

        foreach (var menuItem in _menuItems)
        {
            if (menuItem.Id != itemId && menuItem.IsExpanded)
            {
                menuItem.IsExpanded = false;
            }
        }

        item.IsExpanded = !item.IsExpanded;

        if (item.SubItems.Count == 0)
        {
            activeSubItem = (itemId, -1);
        }

        StateHasChanged();
    }

    private void SelectSubItem(int parentId, int subItemId)
    {
        var parentItem = _menuItems.FirstOrDefault(n => n.Id == parentId);
        var subItem = parentItem?.SubItems.FirstOrDefault(n => n.Id == subItemId);

        if (parentItem == null || subItem == null) return;

        activeSubItem = (parentId, subItemId);

        if (!parentItem.IsExpanded)
        {
            parentItem.IsExpanded = true;

            foreach (var menuItem in _menuItems)
            {
                if (menuItem.Id != parentId)
                {
                    menuItem.IsExpanded = false;
                }
            }
        }

        StateHasChanged();
    }
}