@namespace HITSBlazor.Components.Modals.RightSideModals.ShowTeamModal
@using HITSBlazor.Components.Collapse
@using HITSBlazor.Components.Modals.Components.ModalHeader
@using HITSBlazor.Components.Placeholder
@using HITSBlazor.Components.Tables.TableActionMenu
@using HITSBlazor.Components.Tables.TableBodyRow
@using HITSBlazor.Components.Tables.TableHeader
@using HITSBlazor.Models.Common.Entities
@using HITSBlazor.Models.Common.Enums
@using HITSBlazor.Utils.EnumStyles
@using HITSBlazor.Utils.EnumTranslators

<div class="right-side-modal p-3 overflow-y-scroll" @onclick:stopPropagation="true">
    @if (_isLoading || _currentTeam is null)
    {
        <div class="team-modal-placeholder w-75 h-100">
            <Placeholder Width="w-75" />
            <div class="p-2 bg-white rounded-3 d-flex flex-column gap-1">
                <Placeholder Width="w-50" />
                <Placeholder />
                <Placeholder />
            </div>
            <div class="w-100">
                <table class="table mb-0">
                    <thead>
                        <tr>
                            @for (int i = 0; i < 6; ++i)
                            {
                                <th>
                                    <Placeholder />
                                </th>                                
                            }
                        </tr>
                    </thead>
                    <tbody>
                        @for (int i = 0; i < 5; ++i)
                        {
                            <tr>
                                <td>
                                    <div class="h-100 d-flex align-items-center">
                                        <Placeholder />
                                    </div>
                                </td>
                                @for (int j = 0; j < 5; ++j)
                                {
                                    <td>
                                        <div class="h-100 d-flex align-items-center">
                                            <Placeholder Height="PlaceholderHeight.Small" />
                                        </div>
                                    </td>
                                }
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            <div class="p-2 bg-white rounded-3 gap-2 d-flex">
                <Placeholder Width="w-25" Height="PlaceholderHeight.Small" />
                <Placeholder Width="w-25" Height="PlaceholderHeight.Small" />
                <Placeholder Width="w-25" Height="PlaceholderHeight.Small" />
            </div>
        </div>
        <div class="team-modal-placeholder p-2 w-25 bg-white rounded">
            <div class="d-flex gap-2 w-100 px-1 pt-1">
                <div class="bg-primary w-50 py-3 rounded-3"></div>
                <div class="bg-primary w-50 py-3 rounded-3"></div>
            </div>
            <div class="px-1">
                <Placeholder Width="w-50" />
                <Placeholder />
                <Placeholder />
            </div>
            <div class="px-1">
                <Placeholder Width="w-50" />
                <Placeholder />
                <Placeholder />
                <Placeholder />
            </div>
            <div class="px-1 pb-1">
                <Placeholder />
                <Placeholder Width="w-75" />
                <Placeholder Width="w-75" />
            </div>
        </div>
    }
    else
    {
        <div class="team-modal-side w-75">
            <ModalHeader Title="@_currentTeam.Name" />
            <ul class="list-group rounded-3">
                <li class="list-group-item p-0 overflow-hidden">
                    <Collapse StartCollapsed="false">
                        <MainContent Context="collapse">
                            <button type="button"
                                    @onclick="@(() => collapse.Toggle())"
                                    class="btn d-flex btn-light collapse-controller w-100">
                                Описание команды
                            </button>
                        </MainContent>
                        <ExpandedContent>
                            <div class="list-group">
                                <div class="p-2">
                                    @_currentTeam.Description
                                </div>
                            </div>
                        </ExpandedContent>
                    </Collapse>
                </li>
            </ul>
            <div class="bg-white rounded-3">
                <div class="border-bottom px-3">
                    <ul class="nav nav-underline">
                        <div @onclick="@(() => _activeTableCategory = TeamTableCategory.Members)"
                             class="nav-link fw-normal pb-1 @GetTableCategoryClass(TeamTableCategory.Members)">
                            Участники
                        </div>
                        <div @onclick="@(() => _activeTableCategory = TeamTableCategory.Invitations)"
                             class="nav-link fw-normal pb-1 @GetTableCategoryClass(TeamTableCategory.Invitations)">
                            Приглашения в команду
                        </div>
                        <div @onclick="@(() => _activeTableCategory = TeamTableCategory.RequestsToTeam)"
                             class="nav-link fw-normal pb-1 @GetTableCategoryClass(TeamTableCategory.RequestsToTeam)">
                            Заявки в команду
                        </div>
                        <div @onclick="@(() => _activeTableCategory = TeamTableCategory.RequestsTeamToIdeas)"
                             class="nav-link fw-normal pb-1 @GetTableCategoryClass(TeamTableCategory.RequestsTeamToIdeas)">
                            Заявки в идеи
                        </div>
                        <div @onclick="@(() => _activeTableCategory = TeamTableCategory.InvitationsTeamToIdeas)"
                             class="nav-link fw-normal pb-1 @GetTableCategoryClass(TeamTableCategory.InvitationsTeamToIdeas)">
                            Приглашения в идеи
                        </div>
                    </ul>
                </div>
                <div class="team-modal-tables">
                    <div class="w-100 bg-white px-3 pb-3 pt-1">
                        <div class="py-2 d-flex justify-content-between">
                            <div class="w-50">
                                <div class="input-group">
                                    <sapn class="input-group-text fs-6">
                                        <i class="bi bi-search"></i>
                                    </sapn>
                                    <input type="text" placeholder="Поиск" class="form-control rounded-end" />
                                </div>
                            </div>
                        </div>
                        <div class="w-100 d-flex">
                            <div class="w-100">
                                <table class="table table-hover mb-0">
                                    @switch (_activeTableCategory)
                                    {
                                        case TeamTableCategory.Members:
                                            <TableHeader TableActionMenuIsEnable="true" Items="MembersTableHeader" />
                                            break;
                                        case TeamTableCategory.Invitations:
                                        case TeamTableCategory.RequestsToTeam:
                                            <TableHeader TableActionMenuIsEnable="true" Items="NewMembersTableHeader" />
                                            break;
                                        case TeamTableCategory.RequestsTeamToIdeas:
                                        case TeamTableCategory.InvitationsTeamToIdeas:
                                            break;
                                    }
                                    <tbody>
                                        @if (_activeTableCategory == TeamTableCategory.Members)
                                        {
                                            @foreach (var member in _currentTeam.Members)
                                            {
                                                <tr>
                                                    <TableBodyRow>
                                                        <div class="data-link @(member.Id == _currentTeam.Owner.Id ? "text-warning" : string.Empty)">
                                                            @member.Email
                                                            @(member.Id == _currentTeam.Owner.Id ? " (Владелец)" : string.Empty)
                                                        </div>
                                                    </TableBodyRow>
                                                    <TableBodyRow>
                                                        @member.FirstName
                                                    </TableBodyRow>
                                                    <TableBodyRow>
                                                        @member.LastName
                                                    </TableBodyRow>
                                                    <TableActionMenu ItemId="member.UserId"
                                                                     OnAction="@HandleTableMenuClick"
                                                                     Actions="@(new List<TableAction> { TableAction.ViewProfile })" />
                                                </tr>
                                            }
                                        }
                                        else if (_activeTableCategory == TeamTableCategory.Invitations)
                                        {
                                            @foreach (var invitation in _teamInvitations)
                                            {
                                                <tr>
                                                    <TableBodyRow IsCentered="true">
                                                        <div class="px-2 py-1 rounded-4 @invitation.Status.GetStyle()">
                                                            @invitation.Status.GetTranslation()
                                                        </div>
                                                    </TableBodyRow>
                                                    <TableBodyRow IsCentered="true">
                                                        <div class="data-link">
                                                            @invitation.Email
                                                        </div>
                                                    </TableBodyRow>
                                                    <TableBodyRow IsCentered="true">
                                                        @invitation.FirstName
                                                    </TableBodyRow>
                                                    <TableBodyRow IsCentered="true">
                                                        @invitation.LastName
                                                    </TableBodyRow>
                                                    <TableActionMenu ItemId="invitation.UserId"
                                                                     OnAction="@HandleTableMenuClick"
                                                                     Actions="@(new List<TableAction> { TableAction.ViewProfile })" />
                                                </tr>
                                            }
                                        }
                                        else if (_activeTableCategory == TeamTableCategory.RequestsToTeam)
                                        {
                                            @foreach (var request in _requestsToTeam)
                                            {
                                                <tr>
                                                    <TableBodyRow IsCentered="true">
                                                        <div class="px-2 py-1 rounded-4 @request.Status.GetStyle()">
                                                            @request.Status.GetTranslation()
                                                        </div>
                                                    </TableBodyRow>
                                                    <TableBodyRow IsCentered="true">
                                                        <div class="data-link">
                                                            @request.Email
                                                        </div>
                                                    </TableBodyRow>
                                                    <TableBodyRow IsCentered="true">
                                                        @request.FirstName
                                                    </TableBodyRow>
                                                    <TableBodyRow IsCentered="true">
                                                        @request.LastName
                                                    </TableBodyRow>
                                                    <TableActionMenu ItemId="request.Id"
                                                                     OnAction="@HandleTableMenuClick"
                                                                     Actions="@(new List<TableAction> { 
                                                                        TableAction.ViewProfile, 
                                                                        TableAction.TeamRequestAccept,
                                                                        TableAction.TeamRequestCancel 
                                                                     })" />
                                                </tr>
                                            }
                                        }
                                        else if (_activeTableCategory == TeamTableCategory.RequestsTeamToIdeas)
                                        {
                                            @foreach (var request in _requestsTeamToIdeas)
                                            {
                                                <tr>
                                                    <TableBodyRow>
                                                        <div class="data-link">
                                                            @request.Name
                                                        </div>
                                                    </TableBodyRow>
                                                    <TableBodyRow IsCentered="true">
                                                        <div class="px-2 py-1 rounded-4 @request.Status.GetStyle()">
                                                            @request.Status.GetTranslation()
                                                        </div>
                                                    </TableBodyRow>
                                                    <TableActionMenu ItemId="request.Id"
                                                                     OnAction="@HandleTableMenuClick"
                                                                     Actions="@(new List<TableAction> { TableAction.ViewIdea, TableAction.ViewLetter})" />
                                                </tr>
                                            }
                                        }
                                        else if (_activeTableCategory == TeamTableCategory.InvitationsTeamToIdeas)
                                        {
                                            @foreach (var invitation in _invitationsTeamToIdeas)
                                            {
                                                <tr>
                                                    <TableBodyRow IsCentered="true">
                                                        <div class="px-2 py-1 rounded-4 @invitation.Status.GetStyle()">
                                                            @invitation.Status.GetTranslation()
                                                        </div>
                                                    </TableBodyRow>
                                                    <TableBodyRow>
                                                        <div class="data-link">
                                                            @invitation.IdeaName
                                                        </div>
                                                    </TableBodyRow>
                                                    <TableBodyRow IsCentered="true">
                                                        @foreach (var skill in invitation.Skills)
                                                        {
                                                            <div class="px-2 py-1 rounded d-flex gap-1 @skill.Type.GetStyle()">
                                                                @skill.Name
                                                            </div>
                                                        }
                                                    </TableBodyRow>
                                                </tr>
                                            }
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="rounded-3 bg-white p-3 d-flex flex-wrap gap-3">
                <button type="button" class="btn d-flex btn-light">
                    Редактировать
                </button>
                <button type="button" class="btn d-flex btn-danger">
                    Удалить команду
                </button>
                <button type="button" class="btn d-flex btn-primary">
                    Пригласить пользователя
                </button>
            </div>
        </div>
        <div class="team-modal-side rounded-3 w-25 bg-white">
            <div class="p-2 rounded-top d-flex gap-2">
                <button type="button" 
                        @onclick="@(() => _activeInfoCategory = TeamInfoCategory.Info)"
                        class="btn d-flex w-50 @GetInfoCategoryClass(TeamInfoCategory.Info)">
                    Информация
                </button>
                <button type="button" 
                        @onclick="@(() => _activeInfoCategory = TeamInfoCategory.Skills)"
                        class="btn d-flex w-50 @GetInfoCategoryClass(TeamInfoCategory.Skills)">
                    Компетенции
                </button>
            </div>
            @if (_activeInfoCategory == TeamInfoCategory.Info)
            {
                <div class="team-modal-info w-100 pb-3 px-3">
                    <div class="w-100">
                        <span class="fs-6 border-bottom text-secondary d-block">Владелец команды</span>
                        <div class="team-modal-info-item pt-2">
                            <i class="bi bi-person-circle text-secondary fs-3 opacity-25"></i>
                            <div class="data-link">
                                <span class="fs-6">
                                    @_currentTeam.Owner?.FirstName @_currentTeam.Owner?.LastName
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="w-100">
                        <span class="fs-6 border-bottom text-secondary d-block">Тим-лидер команды</span>
                        <div class="team-modal-info-item pt-2">
                            <i class="bi bi-person-circle text-secondary fs-3 opacity-25"></i>
                            <div class="data-link">
                                <span class="fs-6">
                                    @_currentTeam.Leader?.FirstName @_currentTeam.Leader?.LastName
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="w-100">
                        <span class="fs-6 border-bottom text-secondary d-block">Дата создания</span>
                        <div class="team-modal-info-item pt-2">
                            <i class="bi bi-calendar-date text-secondary fs-3 opacity-25"></i>
                            <span class="fs-6 text-primary">@_currentTeam.CreatedAt.ToString("dd.MM.yyyy")</span>
                        </div>
                    </div>
                    <div class="w-100">
                        <span class="fs-6 border-bottom text-secondary d-block">
                            Количество участников:
                            <span class="fs-6 text-primary">@_currentTeam.MembersCount</span>
                        </span>
                    </div>
                    <button type="button" class="btn d-flex btn-primary">
                        Поделиться командой
                    </button>
                </div>
            }
            else if (_activeInfoCategory == TeamInfoCategory.Skills)
            {
                <div class="team-modal-info px-2 pb-2">
                    <div class="radar-charts">
                        @foreach (var type in Enum.GetValues<SkillType>())
                        {
                            var teamSkills = _currentTeam.Skills.Where(s => s.Type == type).ToList();
                            var teamWantedSkills = _currentTeam.WantedSkills.Where(s => s.Type == type).ToList();
                            var intersectSkills = teamWantedSkills.IntersectBy(teamSkills.Select(s => s.Id), ws => ws.Id).ToList();

                            var allSkills = teamSkills
                                .UnionBy(teamWantedSkills, s => s.Id)
                                .OrderBy(s => s.Name)
                                .ToList();

                            if (allSkills?.Count > 0)
                            {
                                <ApexChart TItem="Skill"
                                           Options="@GetRadarChartOptions()"
                                           Width="250"
                                           Height="275">
                                    <ApexPointSeries TItem="Skill"
                                                     Items="allSkills"
                                                     Name="Желаемые компетенции"
                                                     SeriesType="SeriesType.Radar"
                                                     XValue="@(s => s.Name)"
                                                     YValue="@(s => teamWantedSkills.Contains(s) ? 1 : 0)"
                                                     Color="@type.GetWantedColor()" />
                                    <ApexPointSeries TItem="Skill"
                                                     Items="allSkills"
                                                     Name="Фактические компетенции"
                                                     SeriesType="SeriesType.Radar"
                                                     XValue="@(s => s.Name)"
                                                     YValue="@(s => teamSkills.Contains(s) ? 1 : 0)"
                                                     Color="@type.GetColor()" />
                                    <ApexPointSeries TItem="Skill"
                                                     Items="allSkills"
                                                     Name="Пересечение"
                                                     SeriesType="SeriesType.Radar"
                                                     XValue="@(s => s.Name)"
                                                     YValue="@(s => intersectSkills.Contains(s) ? 1 : 0)"
                                                     Color="#bfbfbf" />
                                </ApexChart>
                            }
                        }
                    </div>
                </div>
            }
        </div>
    }
</div>